package io.quarkiverse.chicory.runtime.wasm;

import java.util.Objects;
import java.util.function.Function;
import java.util.function.Supplier;

import com.dylibso.chicory.compiler.MachineFactoryCompiler;
import com.dylibso.chicory.runtime.Instance;
import com.dylibso.chicory.runtime.InterpreterMachine;
import com.dylibso.chicory.runtime.Machine;

import io.quarkus.logging.Log;

/**
 * Expects that build-time generated bytecode cannot be used.
 */
public class DevTestModeMachineFactoryProvider implements Supplier<Function<Instance, Machine>> {
    private final ExecutionMode executionMode;

    public DevTestModeMachineFactoryProvider(final ExecutionMode executionMode) {
        this.executionMode = executionMode;
    }

    @Override
    public Function<Instance, Machine> get() {
        // DEV/TEST mode live reload works, use the configured execution mode for both static and dynamic Wasm
        // modules
        if (Objects.requireNonNull(executionMode) == ExecutionMode.RuntimeCompiler) {
            Log.info("  DEV/TEST mode, runtime compiler will be used");
            return MachineFactoryCompiler::compile;
        } else {
            Log.info("  DEV/TEST mode, interpreter will be used");
            return InterpreterMachine::new;
        }
    }
}
